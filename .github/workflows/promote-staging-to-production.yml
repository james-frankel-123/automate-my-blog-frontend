# Create or update the staging → main PR when staging is updated.
# Skips the create/update job when an open staging→main PR already exists (so it does not run on that PR).
# Also runnable manually: Actions → Promote staging to production → Run workflow.

name: Promote staging to production

on:
  push:
    branches:
      - staging
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vercel.json'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "production" to confirm (manual run only)'
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: write

jobs:
  check:
    name: Check for open staging→main PR
    runs-on: ubuntu-latest
    outputs:
      open_pr_exists: ${{ steps.query.outputs.open_pr_exists }}
    steps:
      - name: Query open PR
        id: query
        run: |
          COUNT=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?base=main&head=${{ github.repository_owner }}:staging&state=open" | jq 'length')
          echo "open_pr_exists=$([ "$COUNT" -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  ensure-pr:
    name: Create or update PR (staging → main)
    needs: check
    if: needs.check.outputs.open_pr_exists != 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate confirmation (manual run)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ github.event.inputs.confirm }}" ] && [ "${{ github.event.inputs.confirm }}" != "production" ]; then
            echo "::error::Type exactly 'production' to confirm, or leave empty to just ensure the PR exists."
            exit 1
          fi

      - name: Create or find PR (staging → main)
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh pr list --base main --head staging --state open --json number,url --jq '.[0]')
          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
            PR_URL=$(echo "$EXISTING" | jq -r '.url')
            PR_NUM=$(echo "$EXISTING" | jq -r '.number')
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "Existing PR: $PR_URL"
            exit 0
          fi
          PR_URL=$(gh pr create --base main --head staging \
            --title "Promote staging to production" \
            --body "PR from **staging** → **main**. Merge when staging looks good to deploy to production.")
          PR_NUM=$(gh pr view "$PR_URL" --json number --jq '.number')
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

      - name: Comment on PR after push to staging
        if: github.event_name == 'push' && steps.pr.outputs.pr_url != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ steps.pr.outputs.pr_number }}" --body "Staging was updated. Ready to promote when you are — merge this PR to deploy to production."

      - name: Summary
        run: |
          echo "## Promote to production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR (staging → main):** ${{ steps.pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Merge the PR in GitHub to deploy to production. Branch protection rules apply." >> $GITHUB_STEP_SUMMARY
